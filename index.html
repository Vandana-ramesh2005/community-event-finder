<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Event Finder</title>
    <meta name="description" content="Discover local events near you â€” search by location and filter by distance.">
    <link rel="stylesheet" href="style.css">
    <!-- Leaflet for the event-location map drawer -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>

    <!-- â•â• NAVBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <nav>
        <div class="nav-brand">
            <div class="logo-icon">ğŸŒ</div>
            <h2>EventFinder</h2>
        </div>
        <div class="nav-actions">
            <a href="/add-event-page" class="btn">+ Add Event</a>
        </div>
    </nav>

    <!-- â•â• HERO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section class="hero">
        <h1>Discover Events<br>Near You</h1>
        <p>Type any place in Kerala, pick a radius, and find events happening nearby.</p>

        <div class="location-search-bar">
            <span class="search-icon">ğŸ“</span>
            <input type="text" id="locationInput" placeholder="Type a placeâ€¦ e.g. Kochi, Thrissur" autocomplete="off">
            <button class="btn" id="searchBtn" onclick="searchEvents()">Search</button>
        </div>
        <p class="geo-hint">or <button class="link-btn" onclick="useMyLocation()">ğŸ“¡ Use my current location</button>
        </p>

        <div class="filter-chips" id="distanceChips">
            <span class="chip-label">Within:</span>
            <button class="chip active" onclick="setRadius(0,  this)">Any distance</button>
            <button class="chip" onclick="setRadius(5,  this)">5 km</button>
            <button class="chip" onclick="setRadius(10, this)">10 km</button>
            <button class="chip" onclick="setRadius(25, this)">25 km</button>
            <button class="chip" onclick="setRadius(50, this)">50 km</button>
        </div>
    </section>

    <!-- â•â• SECONDARY FILTERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="container">
        <div class="secondary-filters">
            <div class="filter-group">
                <label>District</label>
                <select id="districtFilter" onchange="populatePlaces(); fetchEvents()">
                    <option value="">All Districts</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Place</label>
                <select id="placeFilter" onchange="fetchEvents()">
                    <option value="">All Places</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Category</label>
                <select id="categoryFilter" onchange="fetchEvents()">
                    <option value="">All Categories</option>
                    <option>Music</option>
                    <option>Tech</option>
                    <option>Sports</option>
                    <option>Art</option>
                    <option>Dance</option>
                </select>
            </div>
        </div>

        <div class="section-header">
            <h3>Events</h3>
            <span id="event-count">Loadingâ€¦</span>
        </div>

        <div id="statusMsg" class="status-msg" style="display:none;"></div>
        <div class="event-grid" id="eventGrid"></div>

        <div class="empty-state" id="emptyState" style="display:none;">
            <div class="empty-icon">ğŸ”</div>
            <h4>No events found</h4>
            <p>Try a different location, larger radius, or different filters.</p>
        </div>
    </div>

    <!-- â•â• MAP DRAWER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Slides up from the bottom when user clicks "Interested" on an event.
     Shows the event's venue pinned on a Leaflet map.
-->
    <div id="mapDrawer" class="map-drawer" aria-hidden="true">
        <div class="drawer-handle" onclick="closeMapDrawer()"></div>

        <div class="drawer-header">
            <div class="drawer-event-info">
                <span id="drawerCatBadge" class="card-category"></span>
                <div>
                    <h3 id="drawerTitle"></h3>
                    <p id="drawerMeta" class="drawer-meta"></p>
                </div>
            </div>
            <button class="drawer-close" onclick="closeMapDrawer()" aria-label="Close map">âœ•</button>
        </div>

        <div id="drawerMap"></div>

        <div class="drawer-actions">
            <a id="mapDirectionsBtn" href="#" target="_blank" class="btn" rel="noopener noreferrer">
                ğŸ—ºï¸ Open in Google Maps
            </a>
            <button id="drawerInterestBtn" class="btn btn-outline" onclick="confirmInterest()">
                â­ Mark as Going
            </button>
        </div>
    </div>

    <!-- Backdrop -->
    <div id="mapBackdrop" class="map-backdrop" onclick="closeMapDrawer()"></div>


    <script>
        // â”€â”€ Kerala Districts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const keralaDistricts = {
            "Thiruvananthapuram": ["Thiruvananthapuram City", "Neyyattinkara", "Kattakada"],
            "Kollam": ["Kollam City", "Karunagappally", "Kunnathur"],
            "Pathanamthitta": ["Pathanamthitta Town", "Adoor", "Kozhencherry"],
            "Alappuzha": ["Alappuzha City", "Cherthala", "Chengannur"],
            "Kottayam": ["Kottayam City", "Pala", "Vaikom"],
            "Idukki": ["Painavu", "Thodupuzha", "Munnar"],
            "Ernakulam": ["Kochi", "Aluva", "Muvattupuzha"],
            "Thrissur": ["Thrissur City", "Guruvayur", "Chalakudy"],
            "Palakkad": ["Palakkad City", "Ottapalam", "Chittur"],
            "Malappuram": ["Malappuram City", "Tirur", "Perinthalmanna"],
            "Kozhikode": ["Kozhikode City", "Vatakara", "Thamarassery"],
            "Wayanad": ["Kalpetta", "Sulthan Bathery", "Mananthavady"],
            "Kannur": ["Kannur City", "Taliparamba", "Payyanur"],
            "Kasaragod": ["Kasaragod City", "Kanhangad", "Nileshwar"]
        };

        const distSel = document.getElementById('districtFilter');
        Object.keys(keralaDistricts).sort().forEach(d => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = d;
            distSel.appendChild(opt);
        });

        function populatePlaces() {
            const pSel = document.getElementById('placeFilter');
            const d = document.getElementById('districtFilter').value;
            pSel.innerHTML = '<option value="">All Places</option>';
            if (d && keralaDistricts[d]) {
                keralaDistricts[d].forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = p;
                    pSel.appendChild(opt);
                });
            }
        }

        // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let userLat = null, userLng = null, activeRadius = 0;
        const API = '';

        // â”€â”€ Distance chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function setRadius(r, el) {
            activeRadius = r;
            document.querySelectorAll('#distanceChips .chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            fetchEvents();
        }

        // â”€â”€ Nominatim geocoding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function searchEvents() {
            const query = document.getElementById('locationInput').value.trim();
            if (!query) { showStatus('âš ï¸ Please type a location first.', 'warn'); return; }

            showStatus('ğŸ” Searching for "' + query + '"â€¦', 'info');
            document.getElementById('searchBtn').disabled = true;

            try {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ', Kerala, India')}&format=json&limit=1`;
                const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
                const data = await res.json();

                if (!data.length) { showStatus('âŒ Location not found. Try a more specific name.', 'error'); return; }

                userLat = parseFloat(data[0].lat);
                userLng = parseFloat(data[0].lon);
                showStatus('ğŸ“ Found: ' + data[0].display_name.split(',').slice(0, 2).join(','), 'success');
                await fetchEvents();
            } catch {
                showStatus('âŒ Network error. Make sure you are online.', 'error');
            } finally {
                document.getElementById('searchBtn').disabled = false;
            }
        }

        // â”€â”€ Browser geolocation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function useMyLocation() {
            if (!navigator.geolocation) { showStatus('âŒ Geolocation not supported.', 'error'); return; }
            showStatus('ğŸ“¡ Getting your locationâ€¦', 'info');
            navigator.geolocation.getCurrentPosition(
                pos => {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;
                    document.getElementById('locationInput').value = userLat.toFixed(4) + ', ' + userLng.toFixed(4);
                    showStatus('ğŸ“ Using your current location', 'success');
                    fetchEvents();
                },
                () => showStatus('âŒ Could not access your location.', 'error')
            );
        }

        // â”€â”€ Fetch events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function fetchEvents() {
            const grid = document.getElementById('eventGrid');
            grid.innerHTML = '<div class="loading-spinner">â³ Loading eventsâ€¦</div>';
            document.getElementById('emptyState').style.display = 'none';

            const params = new URLSearchParams();
            if (userLat !== null) { params.set('lat', userLat); params.set('lng', userLng); }
            if (activeRadius > 0) params.set('radius', activeRadius);

            const district = document.getElementById('districtFilter').value;
            const place = document.getElementById('placeFilter').value;
            const category = document.getElementById('categoryFilter').value;
            if (district) params.set('district', district);
            if (place) params.set('place', place);
            if (category) params.set('category', category);

            try {
                const res = await fetch(`${API}/events?${params.toString()}`);
                const events = await res.json();
                renderCards(events);
            } catch {
                grid.innerHTML = '';
                showStatus('âš ï¸ Could not connect to the backend. Is Flask running on port 3000?', 'error');
                document.getElementById('event-count').textContent = '0 events';
            }
        }

        // â”€â”€ Render cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const CAT_ICONS = { Music: 'ğŸµ', Tech: 'ğŸ’»', Sports: 'âš½', Art: 'ğŸ¨', Dance: 'ğŸ’ƒ' };
        const CAT_COLORS = { Music: 'cat-music', Tech: 'cat-tech', Sports: 'cat-sports', Art: 'cat-art', Dance: 'cat-dance' };

        function renderCards(events) {
            const grid = document.getElementById('eventGrid');
            document.getElementById('event-count').textContent =
                events.length + ' event' + (events.length !== 1 ? 's' : '');

            if (!events.length) {
                grid.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            grid.innerHTML = events.map(ev => {
                const icon = CAT_ICONS[ev.category] || 'ğŸ“Œ';
                const catClass = CAT_COLORS[ev.category] || 'cat-default';
                const distBadge = ev.distance_km !== null
                    ? `<span class="distance-badge">ğŸ“ ${ev.distance_km} km away</span>` : '';
                const priceBadge = ev.paid
                    ? `<span class="price-badge paid">â‚¹${ev.price}</span>`
                    : `<span class="price-badge free">Free</span>`;

                /* Embed event data in data-* attributes so the map drawer can read them */
                return `
        <div class="event-card" data-id="${ev.id}"
             data-lat="${ev.lat}" data-lng="${ev.lng}"
             data-name="${ev.name.replace(/"/g, '&quot;')}"
             data-place="${(ev.place + (ev.district ? ', ' + ev.district : '')).replace(/"/g, '&quot;')}"
             data-date="${ev.date}" data-time="${ev.time}"
             data-category="${ev.category}" data-cat-class="${catClass}" data-icon="${icon}"
             data-paid="${ev.paid}" data-price="${ev.price}">

            <div class="card-top-row">
                <div class="card-category ${catClass}">${icon} ${ev.category}</div>
                ${priceBadge}
            </div>
            <h4>${ev.name}</h4>
            <div class="event-meta">
                <div class="meta-item"><span class="icon">ğŸ“…</span> ${ev.date}</div>
                <div class="meta-item"><span class="icon">ğŸ•</span> ${ev.time}</div>
                <div class="meta-item"><span class="icon">ğŸ—ºï¸</span> ${ev.place}${ev.district ? ', ' + ev.district : ''}</div>
            </div>
            <div class="card-footer">
                <button class="interested-btn" onclick="openMapDrawer(this)">â­ Interested</button>
                ${distBadge}
            </div>
        </div>`;
            }).join('');
        }

        // â”€â”€ Map Drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let drawerMap = null;   // Leaflet instance
        let drawerMarker = null;
        let activeCard = null;   // the card whose Interested btn was clicked

        const CAT_ICON_MAP = {
            Music: 'ğŸµ', Tech: 'ğŸ’»', Sports: 'âš½', Art: 'ğŸ¨', Dance: 'ğŸ’ƒ'
        };

        function openMapDrawer(btn) {
            const card = btn.closest('.event-card');
            activeCard = card;

            const lat = parseFloat(card.dataset.lat);
            const lng = parseFloat(card.dataset.lng);
            const name = card.dataset.name;
            const place = card.dataset.place;
            const date = card.dataset.date;
            const time = card.dataset.time;
            const category = card.dataset.category;
            const catClass = card.dataset.catClass;
            const icon = card.dataset.icon;

            // Populate drawer header
            document.getElementById('drawerTitle').textContent = name;
            document.getElementById('drawerMeta').textContent = date + ' Â· ' + time + ' Â· ' + place;

            const catBadge = document.getElementById('drawerCatBadge');
            catBadge.textContent = icon + ' ' + category;
            catBadge.className = 'card-category ' + catClass;

            // Google Maps directions link
            document.getElementById('mapDirectionsBtn').href =
                `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

            // Show drawer + backdrop
            document.getElementById('mapDrawer').classList.add('open');
            document.getElementById('mapBackdrop').classList.add('visible');
            document.body.style.overflow = 'hidden';

            // Init or update Leaflet map
            if (!drawerMap) {
                drawerMap = L.map('drawerMap', { zoomControl: true }).setView([lat, lng], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
                }).addTo(drawerMap);
            } else {
                drawerMap.setView([lat, lng], 14);
                if (drawerMarker) drawerMap.removeLayer(drawerMarker);
            }

            // Custom pulsing marker icon
            const pulseIcon = L.divIcon({
                className: '',
                html: `<div class="pulse-marker">
                   <div class="pulse-ring"></div>
                   <div class="pulse-dot">${icon}</div>
               </div>`,
                iconSize: [48, 48],
                iconAnchor: [24, 24],
                popupAnchor: [0, -28]
            });

            drawerMarker = L.marker([lat, lng], { icon: pulseIcon })
                .addTo(drawerMap)
                .bindPopup(`<strong>${name}</strong><br>${place}<br>${date} Â· ${time}`)
                .openPopup();

            // Fix Leaflet tile sizing after drawer animation
            setTimeout(() => drawerMap.invalidateSize(), 350);
        }

        function closeMapDrawer() {
            document.getElementById('mapDrawer').classList.remove('open');
            document.getElementById('mapBackdrop').classList.remove('visible');
            document.body.style.overflow = '';
            activeCard = null;
        }

        // "Mark as Going" inside the drawer â€” updates the card button too
        function confirmInterest() {
            const btn = document.getElementById('drawerInterestBtn');
            const going = btn.classList.toggle('confirmed');

            if (going) {
                btn.textContent = 'âœ… You\'re Going!';
                btn.style.background = 'linear-gradient(135deg,#34d399,#059669)';
                btn.style.boxShadow = '0 4px 15px rgba(52,211,153,0.45)';
                btn.style.color = 'white';
                btn.style.border = 'none';

                // Mirror on the card's interested button
                if (activeCard) {
                    const cardBtn = activeCard.querySelector('.interested-btn');
                    if (cardBtn) {
                        cardBtn.textContent = 'âœ… Going!';
                        cardBtn.classList.add('active-interest');
                        cardBtn.style.borderColor = '#6c63ff';
                        cardBtn.style.color = '#a29af7';
                    }
                }
            } else {
                btn.textContent = 'â­ Mark as Going';
                btn.style.cssText = '';
                if (activeCard) {
                    const cardBtn = activeCard.querySelector('.interested-btn');
                    if (cardBtn) {
                        cardBtn.textContent = 'â­ Interested';
                        cardBtn.classList.remove('active-interest');
                        cardBtn.style.borderColor = '';
                        cardBtn.style.color = '';
                    }
                }
            }
        }

        // Close drawer on Escape key
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeMapDrawer(); });

        // â”€â”€ Status helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showStatus(msg, type) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = 'status-msg status-' + type;
            el.style.display = 'block';
            if (type === 'success') setTimeout(() => el.style.display = 'none', 3000);
        }

        // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.addEventListener('DOMContentLoaded', fetchEvents);
        document.getElementById('locationInput')?.addEventListener('keydown', e => {
            if (e.key === 'Enter') searchEvents();
        });
    </script>

</body>

</html>